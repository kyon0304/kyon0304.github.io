<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=theme-color content="#494f5c">
<meta name=msapplication-TileColor content="#494f5c">
<meta itemprop=name content="使线上 Spring 应用更好部署和调试">
<meta itemprop=description content="运行一个配置中心，可以方便快捷的更改线上服务多个实例的配置（通过 git commit&git push），配置中心通过服务发现暴露自己的 IP，client 中无需写死 server 地址，在 k8s 中部署也更自然。
运行一个可视化的应用详情 server，可以直观的看到应用健康监控、应用运行的包的构建时间及代码 commit id，应用当前生效的属性并可以动态修改，应用精确到类的日志级别，并可以动态修改。
要做到以上的事情，主要涉及四个组件的配置：
 spring-cloud-config spring-boot-admin spring-zookeeper-discovery spring-boot-actuator  效果展示 配置完成后效果图如下，主要是可视化的应用详情部分的展示，关于配置中心的使用方式的话，目前没有界面，主要就是对 spring-cloud-config server 后端数据的修改，然后 spring 有机制可以让它们动态生效，至少应用重启后可以覆盖 jar 包中的属性配置。
 
  一个美观页面，主要展示了三种信息：
 服务运行了多长时间 当前起的服务: configserver 和 cloud-adapter-aws，是从服务的 spring.application.name 取值 每个服务有几个实例，目前本地测试环境起的，都只有一个实例 服务的版本信息，从 pom.xml 文件种读的 <version>0.1.0</version>   
  右上角切换到 Applications 的页面，以数字+列表形式展示了服务统计信息，当服务比较多的时候这个页面会更直观一些，另外当一个服务有多个实例时，可以从这个页面区分不同实例进入到详情页面。
 
  这里进入 cloud-adapter-aws 服务的一个实例页面，左侧导航栏有三部分，默认进入 Details 这一项。
页面上我会比较关注的部分，
 git 信息，包括 commit id，时间，分支 build 信息，包括版本号，构建时间，当线上出现问题时，可以通过 1，2 这两条信息快速定位到部署对应的包以及代码 健康状态监控，由 /actuator/health 返回的信息稍微规整了一下，可以快速看到依赖的第三方应用比如 mq、zk、db（如果使用了的话） 等组件的健康状态展示出来。另外也可以通过配置包含一些详细信息比如下面的 4 和 5 使用了 spring cloud discovery 的话，会把可以看到的 client 也展示出来 使用了 spring cloud config 的话，会把 config 加载的地址展示出来"><meta itemprop=datePublished content="2020-02-17T21:32:03+08:00">
<meta itemprop=dateModified content="2021-02-26T20:26:39+08:00">
<meta itemprop=wordCount content="965"><meta itemprop=image content="https://kyon.life/media/spring-config/figure-spring-config-1.png">
<meta itemprop=keywords content="分享,spring,配置中心,spring boot,服务发现,"><meta property="og:title" content="使线上 Spring 应用更好部署和调试">
<meta property="og:description" content="运行一个配置中心，可以方便快捷的更改线上服务多个实例的配置（通过 git commit&git push），配置中心通过服务发现暴露自己的 IP，client 中无需写死 server 地址，在 k8s 中部署也更自然。
运行一个可视化的应用详情 server，可以直观的看到应用健康监控、应用运行的包的构建时间及代码 commit id，应用当前生效的属性并可以动态修改，应用精确到类的日志级别，并可以动态修改。
要做到以上的事情，主要涉及四个组件的配置：
 spring-cloud-config spring-boot-admin spring-zookeeper-discovery spring-boot-actuator  效果展示 配置完成后效果图如下，主要是可视化的应用详情部分的展示，关于配置中心的使用方式的话，目前没有界面，主要就是对 spring-cloud-config server 后端数据的修改，然后 spring 有机制可以让它们动态生效，至少应用重启后可以覆盖 jar 包中的属性配置。
 
  一个美观页面，主要展示了三种信息：
 服务运行了多长时间 当前起的服务: configserver 和 cloud-adapter-aws，是从服务的 spring.application.name 取值 每个服务有几个实例，目前本地测试环境起的，都只有一个实例 服务的版本信息，从 pom.xml 文件种读的 <version>0.1.0</version>   
  右上角切换到 Applications 的页面，以数字+列表形式展示了服务统计信息，当服务比较多的时候这个页面会更直观一些，另外当一个服务有多个实例时，可以从这个页面区分不同实例进入到详情页面。
 
  这里进入 cloud-adapter-aws 服务的一个实例页面，左侧导航栏有三部分，默认进入 Details 这一项。
页面上我会比较关注的部分，
 git 信息，包括 commit id，时间，分支 build 信息，包括版本号，构建时间，当线上出现问题时，可以通过 1，2 这两条信息快速定位到部署对应的包以及代码 健康状态监控，由 /actuator/health 返回的信息稍微规整了一下，可以快速看到依赖的第三方应用比如 mq、zk、db（如果使用了的话） 等组件的健康状态展示出来。另外也可以通过配置包含一些详细信息比如下面的 4 和 5 使用了 spring cloud discovery 的话，会把可以看到的 client 也展示出来 使用了 spring cloud config 的话，会把 config 加载的地址展示出来">
<meta property="og:type" content="article">
<meta property="og:url" content="https://kyon.life/post/spring-config/"><meta property="og:image" content="https://kyon.life/media/spring-config/figure-spring-config-1.png"><meta property="article:section" content="post">
<meta property="article:published_time" content="2020-02-17T21:32:03+08:00">
<meta property="article:modified_time" content="2021-02-26T20:26:39+08:00">
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/site.webmanifest>
<link rel=mask-icon href=/safari-pinned-tab.svg color>
<link rel="shortcut icon" href=/favicon.ico>
<title>使线上 Spring 应用更好部署和调试</title>
<link rel=stylesheet href=https://kyon.life/css/style.min.b03ece134bc184525e52c6166866edaf7a587505abe57b4dc58aaf03f4540218.css integrity="sha256-sD7OE0vBhFJeUsYWaGbtr3pYdQWr5XtNxYqvA/RUAhg=" crossorigin=anonymous>
<link rel=stylesheet href=https://kyon.life/css/share.min.css>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://kyon.life/media/spring-config/figure-spring-config-1.png">
<meta name=twitter:title content="使线上 Spring 应用更好部署和调试">
<meta name=twitter:description content="运行一个配置中心，可以方便快捷的更改线上服务多个实例的配置（通过 git commit&git push），配置中心通过服务发现暴露自己的 IP，client 中无需写死 server 地址，在 k8s 中部署也更自然。
运行一个可视化的应用详情 server，可以直观的看到应用健康监控、应用运行的包的构建时间及代码 commit id，应用当前生效的属性并可以动态修改，应用精确到类的日志级别，并可以动态修改。
要做到以上的事情，主要涉及四个组件的配置：
 spring-cloud-config spring-boot-admin spring-zookeeper-discovery spring-boot-actuator  效果展示 配置完成后效果图如下，主要是可视化的应用详情部分的展示，关于配置中心的使用方式的话，目前没有界面，主要就是对 spring-cloud-config server 后端数据的修改，然后 spring 有机制可以让它们动态生效，至少应用重启后可以覆盖 jar 包中的属性配置。
 
  一个美观页面，主要展示了三种信息：
 服务运行了多长时间 当前起的服务: configserver 和 cloud-adapter-aws，是从服务的 spring.application.name 取值 每个服务有几个实例，目前本地测试环境起的，都只有一个实例 服务的版本信息，从 pom.xml 文件种读的 <version>0.1.0</version>   
  右上角切换到 Applications 的页面，以数字+列表形式展示了服务统计信息，当服务比较多的时候这个页面会更直观一些，另外当一个服务有多个实例时，可以从这个页面区分不同实例进入到详情页面。
 
  这里进入 cloud-adapter-aws 服务的一个实例页面，左侧导航栏有三部分，默认进入 Details 这一项。
页面上我会比较关注的部分，
 git 信息，包括 commit id，时间，分支 build 信息，包括版本号，构建时间，当线上出现问题时，可以通过 1，2 这两条信息快速定位到部署对应的包以及代码 健康状态监控，由 /actuator/health 返回的信息稍微规整了一下，可以快速看到依赖的第三方应用比如 mq、zk、db（如果使用了的话） 等组件的健康状态展示出来。另外也可以通过配置包含一些详细信息比如下面的 4 和 5 使用了 spring cloud discovery 的话，会把可以看到的 client 也展示出来 使用了 spring cloud config 的话，会把 config 加载的地址展示出来">
<script src=https://code.jquery.com/jquery-3.5.1.slim.min.js></script>
<link href=/css/zoom.css rel=stylesheet>
<script src=/js/zoom.js></script>
<script src=/js/transition.js></script>
</head>
<body id=page>
<header id=site-header class="animated slideInUp">
<div class="hdr-wrapper section-inner">
<div class=hdr-left>
<div class=site-branding>
<a href=https://kyon.life/>kyon's wonderland with ❤️</a>
</div>
<nav class="site-nav hide-in-mobile">
<a href=https://kyon.life/post/>博文</a>
<a href=https://kyon.life/about/>关于</a>
</nav>
</div>
<div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://instagram.com/kyon_wy target=_blank rel="noopener me" title=Instagram><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/></svg></a><a href=https://github.com/kyon0304 target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=菜单><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
</div>
</div>
</header>
<div id=mobile-menu class="animated fast">
<ul>
<li><a href=https://kyon.life/post/>博文</a></li>
<li><a href=https://kyon.life/about/>关于</a></li>
</ul>
</div>
<main class="site-main main-content section-inner animated fadeIn faster" id=site-main>
<article class=thin>
<header class=post-header>
<div class=post-meta><span>2 月 17 号, 2020</span></div>
<h1>使线上 Spring 应用更好部署和调试</h1>
</header>
<div class=content>
<p>运行一个配置中心，可以方便快捷的更改线上服务多个实例的配置（通过 git commit&git push），配置中心通过服务发现暴露自己的 IP，client 中无需写死 server 地址，在 k8s 中部署也更自然。</p>
<p>运行一个可视化的应用详情 server，可以直观的看到应用健康监控、应用运行的包的构建时间及代码 commit id，应用当前生效的属性并可以动态修改，应用精确到类的日志级别，并可以动态修改。</p>
<p>要做到以上的事情，主要涉及四个组件的配置：</p>
<ul>
<li>spring-cloud-config</li>
<li>spring-boot-admin</li>
<li>spring-zookeeper-discovery</li>
<li>spring-boot-actuator</li>
</ul>
<h2 id=效果展示>效果展示<a href=#效果展示 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2>
<p>配置完成后效果图如下，主要是可视化的应用详情部分的展示，关于配置中心的使用方式的话，目前没有界面，主要就是对 spring-cloud-config server 后端数据的修改，然后 spring 有机制可以让它们动态生效，至少应用重启后可以覆盖 jar 包中的属性配置。</p>
<figure>
<img src=/media/spring-config/figure-spring-config-1.png alt=figure-1 data-action=zoom>
</img>
<figcaption><p></p></figcaption>
</figure>
<p>一个美观页面，主要展示了三种信息：</p>
<ul>
<li>服务运行了多长时间</li>
<li>当前起的服务: configserver 和 cloud-adapter-aws，是从服务的 <code>spring.application.name</code> 取值</li>
<li>每个服务有几个实例，目前本地测试环境起的，都只有一个实例</li>
<li>服务的版本信息，从 pom.xml 文件种读的 <code>&lt;version>0.1.0&lt;/version></code></li>
</ul>
<figure>
<img class=big src=/media/spring-config/figure-spring-config-5.png alt=figure-5 data-action=zoom>
</img>
<figcaption><p></p></figcaption>
</figure>
<p>右上角切换到 <code>Applications</code> 的页面，以数字+列表形式展示了服务统计信息，当服务比较多的时候这个页面会更直观一些，另外当一个服务有多个实例时，可以从这个页面区分不同实例进入到详情页面。</p>
<figure>
<img class=big src=/media/spring-config/figure-spring-config-2.png alt=figure-2 data-action=zoom>
</img>
<figcaption><p></p></figcaption>
</figure>
<p>这里进入 <code>cloud-adapter-aws</code> 服务的一个实例页面，左侧导航栏有三部分，默认进入 <code>Details</code> 这一项。</p>
<p>页面上我会比较关注的部分，</p>
<ol>
<li>git 信息，包括 commit id，时间，分支</li>
<li>build 信息，包括版本号，构建时间，当线上出现问题时，可以通过 1，2 这两条信息快速定位到部署对应的包以及代码</li>
<li>健康状态监控，由 /actuator/health 返回的信息稍微规整了一下，可以快速看到依赖的第三方应用比如 mq、zk、db（如果使用了的话） 等组件的健康状态展示出来。另外也可以通过配置包含一些详细信息比如下面的 4 和 5</li>
<li>使用了 spring cloud discovery 的话，会把可以看到的 client 也展示出来</li>
<li>使用了 spring cloud config 的话，会把 config 加载的地址展示出来</li>
</ol>
<figure>
<img class=big src=/media/spring-config/figure-spring-config-3.png alt=figure-3 data-action=zoom>
</img>
<figcaption><p></p></figcaption>
</figure>
<p>这个页面展示了应用从各个地方加载的属性值，包括 application.properties, application-${PROFILE}.properties, bootstrap.properties, system properties 以及从 spring cloud config server 拉取下来的属性值。</p>
<p>分成上下部分，可以先从下半部分搜索属性 key，看到原属性值，然后在上半部分选取要修改的属性 key，然后填入想要修改的目标值后，<code>Refresh Context</code>，就可以动态修改属性值。</p>
<figure>
<img class=big src=/media/spring-config/figure-spring-config-4.png alt=figure-4 data-action=zoom>
</img>
<figcaption><p></p></figcaption>
</figure>
<p>日志级别页面，可以非常方便而且精确地查看某个包的日志级别并动态修改，在定位线上问题时，非常好用。</p>
<h2 id=配置中心>配置中心<a href=#配置中心 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2>
<p>spring-cloud-config 分为 server 和 client 两部分，server 是配置中心，负责适配各种后端存储配置，这里选取的是 git 作为存储后端，client 负责从 server 拉取配置</p>
<h3 id=spring-cloud-config-server-配置>spring-cloud-config server 配置<a href=#spring-cloud-config-server-配置 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3>
<p>server 部分配置，引入依赖</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=c>&lt;!-- pom.xml --&gt;</span>

<span class=c>&lt;!-- Spring Cloud Config Server --&gt;</span>
<span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-config-server<span class=nt>&lt;/artifactId&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>应用入口处标注注解</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=nd>@EnableConfigServer</span>
<span class=nd>@SpringBootApplication</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>AdminApplication</span> <span class=o>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>SpringApplication</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>AdminApplication</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>并对 config server 的后端配置如下，暂时配置为本地地址做测试用</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1>##################################### Spring Cloud Config Server Start ##################################################</span>
<span class=c1># 用户需要修改配置时，修改这个库中对应的文件，并提交&amp;push</span>
<span class=c1># 应用可以动态修改，如果没有生效或进入一种未知状态，可以重启应用，这时新修改的属性肯定就可以生效了</span>
spring.cloud.config.server.git.uri<span class=o>=</span>file://<span class=si>${</span><span class=nv>user</span><span class=p>.home</span><span class=si>}</span>/config-repo
<span class=c1>##################################### Spring Cloud Config Server End ####################################################</span>
</code></pre></td></tr></table>
</div>
</div><p>这样的话，应该就可以用了，在 client 配置部分指定 server 的地址。但是我这边希望 client 可以通过服务发现直接得到 server 地址，这样不同环境部署时，不需要分别配置 server 地址，会更灵活一些，而且对失败迁移也更友好。</p>
<p>这里选取的是基于 zookeeper 的服务发现机制，所以另外引入依赖 <code>spring-cloud-starter-zookeeper-discovery</code>，由于使用的是 3.4.10 版本的 zk，所以重新引入一下，logger 统一使用的是 logback，所以也需要从 zk 的依赖中去除对 slf4j 的依赖。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=c>&lt;!-- Spring Cloud Zookeeper Discovery --&gt;</span>
<span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-zookeeper-discovery<span class=nt>&lt;/artifactId&gt;</span>
    <span class=nt>&lt;version&gt;</span>${spring-cloud-zk-discovery.version}<span class=nt>&lt;/version&gt;</span>
    <span class=nt>&lt;exclusions&gt;</span>
        <span class=nt>&lt;exclusion&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.apache.zookeeper<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>zookeeper<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;/exclusion&gt;</span>
    <span class=nt>&lt;/exclusions&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
<span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.apache.zookeeper<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>zookeeper<span class=nt>&lt;/artifactId&gt;</span>
    <span class=nt>&lt;version&gt;</span>3.4.10<span class=nt>&lt;/version&gt;</span>
    <span class=nt>&lt;exclusions&gt;</span>
        <span class=nt>&lt;exclusion&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.slf4j<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>slf4j-log4j12<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;/exclusion&gt;</span>
    <span class=nt>&lt;/exclusions&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>并在入口类添加注解 <code>@EnableDiscoveryClient</code>，于是变成：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=nd>@EnableConfigServer</span>
<span class=nd>@EnableDiscoveryClient</span>
<span class=nd>@SpringBootApplication</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>AdminApplication</span> <span class=o>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>SpringApplication</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>AdminApplication</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后在 <code>application.properties</code> 中添加如下配置</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1>################################### Spring Cloud ZooKeeper Discovery Start ##############################################</span>
spring.cloud.zookeeper.discovery.enabled<span class=o>=</span><span class=nb>true</span>
<span class=c1>#当前服务在 zk 注册时，使用 IP 进行注册，不配置的话默认会取 hostname，对于设置了自己 hostname 但是调用方无法解析的情况不够友好         </span>
spring.cloud.zookeeper.discovery.prefer-ip-address<span class=o>=</span><span class=nb>true</span> 
<span class=c1>#配置 spring cloud zk discovery 使用的 zk 地址</span>
spring.cloud.zookeeper.connect-string<span class=o>=</span>192.168.31.171:2181
<span class=c1># 由于我本地安装了 VMware 和 virtual box，以及开了 VPN，会有虚拟网卡，设置这个属性后就不会去拿这些虚拟网卡的 IP 在 zk 中注册</span>
spring.cloud.inetutils.ignoredInterfaces<span class=o>=</span>VMware.*, Hyper-V.*, TAP-Windows.*, VirtualBox.*
<span class=c1>################################### Spring Cloud ZooKeeper Discovery End ################################################</span>
</code></pre></td></tr></table>
</div>
</div><p>加完如上配置，spring-cloud-config 的 server 部分就算配置完毕了</p>
<h3 id=spring-cloud-config-client-配置>spring-cloud-config client 配置<a href=#spring-cloud-config-client-配置 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3>
<p>接下来看下 client 部分的配置</p>
<p>首先依然是在 <code>pom.xml</code> 中引入依赖，这里同时引入了 spring-cloud-starter-config 和 spring-cloud-starter-zookeeper-discovery，不再分开说明</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=c>&lt;!-- spring cloud config client--&gt;</span>
<span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-config<span class=nt>&lt;/artifactId&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
<span class=c>&lt;!-- discovery client --&gt;</span>
<span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.cloud<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-cloud-starter-zookeeper-discovery<span class=nt>&lt;/artifactId&gt;</span>
    <span class=nt>&lt;version&gt;</span>${spring-cloud-zk-discovery.version}<span class=nt>&lt;/version&gt;</span>
    <span class=nt>&lt;exclusions&gt;</span>
        <span class=nt>&lt;exclusion&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.apache.zookeeper<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>zookeeper<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;/exclusion&gt;</span>
    <span class=nt>&lt;/exclusions&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
<span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.apache.zookeeper<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>zookeeper<span class=nt>&lt;/artifactId&gt;</span>
    <span class=nt>&lt;version&gt;</span>3.4.10<span class=nt>&lt;/version&gt;</span>
    <span class=nt>&lt;exclusions&gt;</span>
        <span class=nt>&lt;exclusion&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.slf4j<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>slf4j-log4j12<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;/exclusion&gt;</span>
    <span class=nt>&lt;/exclusions&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>然后在入口类加注解，打开服务发现</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=nd>@SpringBootApplication</span>
<span class=nd>@EnableDiscoveryClient</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>AwsApplication</span> <span class=kd>extends</span> <span class=n>SpringBootServletInitializer</span> <span class=o>{</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>logger</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=n>AwsApplication</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>ApplicationContext</span> <span class=n>application</span> <span class=o>=</span> <span class=n>SpringApplication</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>AwsApplication</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isDebugEnabled</span><span class=o>())</span> <span class=o>{</span>
            <span class=n>String</span><span class=o>[]</span> <span class=n>beanDefinitionNames</span> <span class=o>=</span> <span class=n>application</span><span class=o>.</span><span class=na>getBeanDefinitionNames</span><span class=o>();</span>
            <span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>beanName</span> <span class=o>:</span> <span class=n>beanDefinitionNames</span><span class=o>)</span> <span class=o>{</span>
                <span class=n>logger</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=n>beanName</span><span class=o>);</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>配置 <code>application.propeties</code></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=c1>################################### Spring Cloud ZooKeeper Discovery Start ##############################################</span>
<span class=c1># 在 zk 中注册当前服务</span>
spring.cloud.zookeeper.discovery.register<span class=o>=</span><span class=nb>true</span>
<span class=c1># 使能发现 zk 中注册的服务</span>
spring.cloud.zookeeper.discovery.enabled<span class=o>=</span><span class=nb>true</span>
<span class=c1># 使用服务所在主机 IP 在 zk 中进行注册</span>
spring.cloud.zookeeper.discovery.prefer-ip-address<span class=o>=</span><span class=nb>true</span>
<span class=c1># 使能通过服务发现获得 spring-cloud-config server 地址</span>
spring.cloud.config.discovery.enabled<span class=o>=</span><span class=nb>true</span>
<span class=c1># 指定 zk 中作为 spring-cloud-config server 的服务，默认是 configserver，如果 spring-cloud-config server 那边的 spring.application.name 不是 configserver 的话，可以用这个属性进行跟随</span>
spring.cloud.config.discovery.service-id<span class=o>=</span>configserver
<span class=c1># 打开 spring cloud config 功能，其实只要有 bootstrap.propterties|yml 文件就会自动打开</span>
spring.cloud.config.enabled<span class=o>=</span><span class=nb>true</span>
<span class=c1># 和 spring.cloud.config.profile 一起指定 spring-cloud-config server 拉取的文件：`${spring.cloud.config.name}-${spring.cloud.config.profile}.properties|yml`</span>
spring.cloud.config.profile<span class=o>=</span><span class=si>${</span><span class=nv>spring</span><span class=p>.profiles.active</span><span class=si>}</span>
<span class=c1># 和 spring.cloud.config.name 一起指定 spring-cloud-config server 拉取的文件 ：`${spring.cloud.config.name}-${spring.cloud.config.profile}.properties|yml`</span>
spring.cloud.config.name<span class=o>=</span><span class=si>${</span><span class=nv>spring</span><span class=p>.application.name</span><span class=si>}</span>
<span class=c1># 可以是个数组，指定优先拉取的 git 分支/commit id 等信息</span>
spring.cloud.config.label<span class=o>=</span>master
<span class=c1>################################### Spring Cloud ZooKeeper Discovery End ################################################</span>
</code></pre></td></tr></table>
</div>
</div><p>以上，就完成了 spring-cloud-config 的 client 和 server 端的配置，并且支持通过服务发现来动态获取 server 地址。</p>
<h2 id=可视化>可视化<a href=#可视化 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2>
<p>配置的存取搞定了，下一步来配置可视化部分。这时就用到了 spring-boot-admin 和 spring-boot-actuator。其中 actuator 会从 spring 应用中提取得到数据，包括配置、健康监控以及日志级别等等，并通过 http 的 endpoint 暴露出来，spring boot admin 则会定时请求这些 endpoint 汇总这些信息并通过一个比较美观的前端页面展示出来。</p>
<h3 id=actuator-配置>actuator 配置<a href=#actuator-配置 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3>
<p>引入 pom 依赖</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=c>&lt;!-- spring-boot-actuator--&gt;</span>
<span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class=nt>&lt;/artifactId&gt;</span>
    <span class=nt>&lt;version&gt;</span>2.1.6.RELEASE<span class=nt>&lt;/version&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>配置文件添加如下neir</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1>############################################# Actuator Start ############################################################</span>
<span class=c1># 要在 http endpoint 中暴露的 actuator 内容</span>
management.endpoints.web.exposure.include<span class=o>=</span>health,info,env,loggers,refresh
<span class=c1># 是否允许在页面上进行 RefreshContext 操作（动态更新属性），需要上面一条属性中包含 refresh</span>
management.endpoint.refresh.enabled<span class=o>=</span><span class=nb>true</span>
<span class=c1># 展示详细信息，比如 zk 的连接地址，如果不配置，可能只显示 up 或 down</span>
management.endpoint.health.show-details<span class=o>=</span>always
<span class=c1># 展示应用详情信息</span>
management.endpoint.info.enabled<span class=o>=</span><span class=nb>true</span>
<span class=c1># 展示环境信息</span>
management.endpoint.env.enabled<span class=o>=</span><span class=nb>true</span>
<span class=c1># 对环境信息中指定属性的值进行脱敏</span>
management.endpoint.env.keys-to-sanitize<span class=o>=</span>password,secret,key,token
<span class=c1># 展示日志级别页面</span>
management.endpoint.loggers.enabled<span class=o>=</span><span class=nb>true</span>
<span class=c1>############################################# Actuator End ##############################################################</span>
</code></pre></td></tr></table>
</div>
</div><p>另外如果需要在应用详情中展示 git 和 build info，还需要在 pom 中进行配置生成一下</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;build&gt;</span>
    <span class=nt>&lt;finalName&gt;</span>cloud-adapter-aws<span class=nt>&lt;/finalName&gt;</span>
    <span class=nt>&lt;plugins&gt;</span>
        <span class=nt>&lt;plugin&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;executions&gt;</span>
                <span class=nt>&lt;execution&gt;</span>
                    <span class=nt>&lt;goals&gt;</span>
                        <span class=nt>&lt;goal&gt;</span>build-info<span class=nt>&lt;/goal&gt;</span>
                    <span class=nt>&lt;/goals&gt;</span>
                    <span class=nt>&lt;phase&gt;</span>package<span class=nt>&lt;/phase&gt;</span>
                <span class=nt>&lt;/execution&gt;</span>
            <span class=nt>&lt;/executions&gt;</span>
        <span class=nt>&lt;/plugin&gt;</span>
        <span class=nt>&lt;plugin&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>pl.project13.maven<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>git-commit-id-plugin<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;executions&gt;</span>
                <span class=nt>&lt;execution&gt;</span>
                    <span class=nt>&lt;id&gt;</span>get-id-info<span class=nt>&lt;/id&gt;</span>
                    <span class=nt>&lt;goals&gt;</span>
                        <span class=nt>&lt;goal&gt;</span>revision<span class=nt>&lt;/goal&gt;</span>
                    <span class=nt>&lt;/goals&gt;</span>
                    <span class=nt>&lt;phase&gt;</span>package<span class=nt>&lt;/phase&gt;</span>
                <span class=nt>&lt;/execution&gt;</span>
                <span class=nt>&lt;execution&gt;</span>
                    <span class=nt>&lt;id&gt;</span>validate-git-info<span class=nt>&lt;/id&gt;</span>
                    <span class=nt>&lt;goals&gt;</span>
                        <span class=nt>&lt;goal&gt;</span>validateRevision<span class=nt>&lt;/goal&gt;</span>
                    <span class=nt>&lt;/goals&gt;</span>
                <span class=nt>&lt;/execution&gt;</span>
            <span class=nt>&lt;/executions&gt;</span>
        <span class=nt>&lt;/plugin&gt;</span>
    <span class=nt>&lt;/plugins&gt;</span>
<span class=nt>&lt;/build&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>这样在打包的时候就会自动生成 git 和 build 信息。</p>
<h3 id=spring-boot-admin-配置>spring-boot-admin 配置<a href=#spring-boot-admin-配置 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3>
<p>现在数据有了，接下来需要有人去做汇总并展示，于是 spring-boot-admin 出场。</p>
<p>spring-boot-admin 也是分为 server 和 client 两部分，和 spring-cloud-config 相反，spring-boot-admin 是 server 拉取 client 数据，所以，一般来说，需要每个应用引入 spring-boot-admin-client 依赖，并且配置 spring-boot-admin server 地址，但是既然 spring-cloud-config client 可以通过服务发现找到 server，那么 spring-boot-admin 的 server 也可以通过服务发现找到 client，而且这样配置以后，client 端不仅不再需要配置 server 地址，而且还可以去掉对 spring-boot-admin-client 的依赖。</p>
<p>这里我把 spring-boot-admin server 和 spring-cloud-config server 放到了一起，节省一些空间和端口占用，使用服务发现的 spring-boot-admin server 配置比较简单，只需要在 pom 中引入 starter 依赖，然后在入口类加注解，其他配置都由 starter 帮助完成，下面看一下具体配置</p>
<p>pom 依赖：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=c>&lt;!-- Spring Boot Admin Server --&gt;</span>
<span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>de.codecentric<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-boot-admin-starter-server<span class=nt>&lt;/artifactId&gt;</span>
    <span class=nt>&lt;version&gt;</span>${spring-boot-admin.version}<span class=nt>&lt;/version&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
<span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-web<span class=nt>&lt;/artifactId&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>入口类新增注解 <code>@EnableAdminServer</code>，终于得到最终体</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=nd>@EnableAdminServer</span>
<span class=nd>@EnableConfigServer</span>
<span class=nd>@EnableDiscoveryClient</span>
<span class=nd>@SpringBootApplication</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>AdminApplication</span> <span class=o>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>SpringApplication</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>AdminApplication</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>args</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>但是由于 spring-boot-admin server 和 spring-cloud-config server 的合并，引入了一个新问题，就是两个都会用到 8888 端口的 <code>/</code> 这个 endpoint，于是这边需要给它们岔开，spring-cloud-config server 用 <code>/config</code> 这个 uri，于是需要做以下额外配置：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=c1># spring-cloud-config server 对外提供服务的网址新增 /config。</span>
<span class=c1># 比如原来 cloud-adapter-aws client 获取 dev 环境属性的请求是 http://localhost:8888/cloud-adapter-aws/dev </span>
<span class=c1># 配置这个属性后变为 http://localhost:8888/config/cloud-adapter-aws/dev </span>
spring.cloud.config.server.prefix<span class=o>=</span>/config
<span class=c1># 告知 client 从 server 拉取配置时，需要在 uri /config 下，否则 client 就会从根目录去拉取</span>
spring.cloud.zookeeper.discovery.metadata.configPath<span class=o>=</span>/config
</code></pre></td></tr></table>
</div>
</div><p>由于使用了服务发现，spring-boot-admin client 部分不需要做任何配置，server 会自动从 zk 中拿到它们的地址，并请求 /actuator/health 等 endpoint 获取数据，进行汇总，统一展示。</p>
<p>明天再看一下加密属性部分，后续如果有时间，还要看下 spring boot admin 网页密码登录</p>
<p>写的有点乱，先这样，以后再改。</p>
</div>
<div class="related-posts thin">
<h2>相关推荐</h2>
<ul>
<li><a href=/post/config-server-with-spring-boot-and-disconf/>基于 Spring Boot + Disconf 的配置中心</a></li>
</ul>
</div>
<hr class=post-end>
<footer class=post-info>
<p>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://kyon.life/tags/%E5%88%86%E4%BA%AB>分享</a></span><span class=tag><a href=https://kyon.life/tags/spring>spring</a></span><span class=tag><a href=https://kyon.life/tags/%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83>配置中心</a></span><span class=tag><a href=https://kyon.life/tags/spring-boot>spring boot</a></span><span class=tag><a href=https://kyon.life/tags/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0>服务发现</a></span>
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>约 11448 字</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2020-02-17 13:32</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=https://github.com/kyon0304/kyon0304.github.io/5d1291eff84f99177f2b55dc7ea896b2ecce2c8d/a7666d216953621da5cea4c3710181cdfe449773 target=_blank rel=noopener>a7666d2</a> @ 2021-02-26</p>
</footer>
<div class=social-share data-initialized=true data-wechat-qrcode-title=扫描分享>
<center>
<span style=font-size:16px;color:#c05b4d>分享到：</span>
<a href=# class="social-share-icon icon-weibo"></a>
<a href=# class="social-share-icon icon-wechat"></a>
<a href=# class="social-share-icon icon-twitter"></a>
<a href=# class="social-share-icon icon-qq"></a>
<a href=# class="social-share-icon icon-qzone"></a>
</center>
</div>
<script src=/js/social-share.min.js></script>
</article>
<aside class=post-toc id=toc>
<nav id=TableOfContents>
<ul>
<li><a href=#效果展示>效果展示</a></li>
<li><a href=#配置中心>配置中心</a>
<ul>
<li><a href=#spring-cloud-config-server-配置>spring-cloud-config server 配置</a></li>
<li><a href=#spring-cloud-config-client-配置>spring-cloud-config client 配置</a></li>
</ul>
</li>
<li><a href=#可视化>可视化</a>
<ul>
<li><a href=#actuator-配置>actuator 配置</a></li>
<li><a href=#spring-boot-admin-配置>spring-boot-admin 配置</a></li>
</ul>
</li>
</ul>
</nav>
</aside>
</main>
<div class="post-nav thin">
<a class=next-post href=https://kyon.life/post/philosophy-of-software-design-1/>
<span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;新</span><br><span>Philosophy of Software Design 第一章 介绍（一切都与复杂性有关）</span>
</a>
<a class=prev-post href=https://kyon.life/post/philosophy-of-software-design-11/>
<span class=post-nav-label>旧&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Philosophy of Software Design 第十一章 设计两次</span>
</a>
</div>
<div id=comments class=thin>
<script src=https://utteranc.es/client.js repo=kyon0304/kyon0304.github.io issue-term=pathname label=Comment theme=github-light crossorigin=anonymous async></script>
</div>
<footer id=site-footer class="section-inner thin animated fadeIn faster">
<p>&copy; 2021 <a href=https://kyon.life/>kyon</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p>
<p>
Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://kyon.life/sitemap.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a>
</p>
</footer>
<script src=https://kyon.life/js/bundle.min.424fb3fd7b1567f65bac76d06824a201d4d7f5c5b670a3c0827050af1755e9a1.js integrity="sha256-Qk+z/XsVZ/ZbrHbQaCSiAdTX9cW2cKPAgnBQrxdV6aE=" crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-131420074-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$'],['\\(','\\)']]},showProcessingMessages:!1,messageStyle:'none'}</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-131420074-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script src=/js/social-share.min.js></script>
</body>
</html>