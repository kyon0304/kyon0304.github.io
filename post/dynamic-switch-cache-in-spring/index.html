<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="Spring æ¡†æ¶ç¼“å­˜æ•…éšœè‡ªåŠ¨åˆ‡æ¢">
<meta itemprop="description" content="ç¼“å­˜åªæ˜¯æé«˜è®¿é—®é€Ÿåº¦ï¼Œå¦‚ä½•é…ç½® Spring CacheManagerï¼Œä½¿å¾—ç¼“å­˜ä¸å¯ç”¨æ—¶ï¼Œä¸å½±å“åº”ç”¨æ­£å¸¸è¿è¡Œï¼Œä¸å½±å“æ¥å£æ­£å¸¸è¿”å›ã€‚">
<meta itemprop="datePublished" content="2020-09-29T15:40:36+08:00" />
<meta itemprop="dateModified" content="2021-02-26T20:26:39+08:00" />
<meta itemprop="wordCount" content="769">
<meta itemprop="image" content="https://kyon.life/mstile-150x150.png"/>



<meta itemprop="keywords" content="spring,cache,redis,åˆ†äº«," />
<meta property="og:title" content="Spring æ¡†æ¶ç¼“å­˜æ•…éšœè‡ªåŠ¨åˆ‡æ¢" />
<meta property="og:description" content="ç¼“å­˜åªæ˜¯æé«˜è®¿é—®é€Ÿåº¦ï¼Œå¦‚ä½•é…ç½® Spring CacheManagerï¼Œä½¿å¾—ç¼“å­˜ä¸å¯ç”¨æ—¶ï¼Œä¸å½±å“åº”ç”¨æ­£å¸¸è¿è¡Œï¼Œä¸å½±å“æ¥å£æ­£å¸¸è¿”å›ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kyon.life/post/dynamic-switch-cache-in-spring/" />
<meta property="og:image" content="https://kyon.life/mstile-150x150.png"/>
<meta property="article:published_time" content="2020-09-29T15:40:36+08:00" />
<meta property="article:modified_time" content="2021-02-26T20:26:39+08:00" />

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Spring æ¡†æ¶ç¼“å­˜æ•…éšœè‡ªåŠ¨åˆ‡æ¢</title>
	<link rel="stylesheet" href="https://kyon.life/css/style.min.cc8092f337b406ae2cf62b71d2d7b0164c73e23a7a7a46b211eab7af33890034.css" integrity="sha256-zICS8ze0Bq4s9itx0tewFkxz4jp6ekayEeq3rzOJADQ=" crossorigin="anonymous">
	<link rel="stylesheet" href="https://kyon.life/css/share.min.css">
	<meta name="twitter:card" content="summary"/>
<meta name="twitter:image" content="https://kyon.life/mstile-150x150.png"/>

<meta name="twitter:title" content="Spring æ¡†æ¶ç¼“å­˜æ•…éšœè‡ªåŠ¨åˆ‡æ¢"/>
<meta name="twitter:description" content="ç¼“å­˜åªæ˜¯æé«˜è®¿é—®é€Ÿåº¦ï¼Œå¦‚ä½•é…ç½® Spring CacheManagerï¼Œä½¿å¾—ç¼“å­˜ä¸å¯ç”¨æ—¶ï¼Œä¸å½±å“åº”ç”¨æ­£å¸¸è¿è¡Œï¼Œä¸å½±å“æ¥å£æ­£å¸¸è¿”å›ã€‚"/>


	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
	<link href="/css/zoom.css" rel="stylesheet">
	<script src="/js/zoom.js"></script>
	<script src="/js/transition.js"></script>
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://kyon.life/">kyon&#39;s wonderland with â¤ï¸</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://kyon.life/post/">åšæ–‡</a>
				<a href="https://kyon.life/about/">å…³äº</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href="https://instagram.com/kyon_wy" target="_blank" rel="noopener me" title="Instagram"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"></line></svg></a><a href="https://github.com/kyon0304" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="èœå•"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://kyon.life/post/">åšæ–‡</a></li>
			<li><a href="https://kyon.life/about/">å…³äº</a></li>
		</ul>
	</div>


	<main class="site-main main-content section-inner animated fadeIn faster" id = "site-main">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>9 æœˆ 29 å·, 2020</span></div>
				<h1>Spring æ¡†æ¶ç¼“å­˜æ•…éšœè‡ªåŠ¨åˆ‡æ¢</h1>
			</header>
			<div class="content">
				<h2 id="ç°çŠ¶">ç°çŠ¶<a href="#ç°çŠ¶" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>ç¼“å­˜åªæ˜¯æé«˜è®¿é—®é€Ÿåº¦ï¼Œåº”ç”¨æœ¬èº«æ²¡æœ‰å¾ˆé«˜çš„å¹¶å‘è®¿é—®é‡ï¼Œç¼“å­˜ä¸å¯ç”¨æ—¶ï¼Œæ•°æ®åº“ä¹Ÿèƒ½é¡¶ä½ã€‚ä½†æ˜¯ç¼“å­˜æŒ‚æ‰ä»¥åï¼ŒSpring CacheManager é»˜è®¤ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ–¹æ³•ç›´æ¥å°±å¼‚å¸¸é€€å‡ºäº†ã€‚</p>
<h2 id="ç›®æ ‡">ç›®æ ‡<a href="#ç›®æ ‡" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>ç¼“å­˜ä¸å¯ç”¨æ—¶ï¼Œä¸å½±å“åº”ç”¨æ­£å¸¸è¿è¡Œï¼Œä¸å½±å“æ¥å£æ­£å¸¸è¿”å›ã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ<a href="#è§£å†³æ–¹æ¡ˆ" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="æ–¹æ¡ˆä¸€">æ–¹æ¡ˆä¸€<a href="#æ–¹æ¡ˆä¸€" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>æœ€ç›´æ¥çš„æ–¹æ¡ˆï¼ŒSpring å®šä¹‰çš„ error handler é»˜è®¤æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œè¦†ç›– handler å¹¶ catch ä½å¼‚å¸¸ä¸è¦æŠ›å‡ºå°±å¯ä»¥ä¸å½±å“æ­£å¸¸å¤„ç†æµç¨‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CacheErrorLoggingHandler</span> <span class="kd">extends</span> <span class="n">SimpleCacheErrorHandler</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">CacheErrorLoggingHandler</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">private</span> <span class="n">ClientResources</span> <span class="n">clientResources</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setClientResources</span><span class="o">(</span><span class="n">ClientResources</span> <span class="n">clientResources</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">clientResources</span> <span class="o">=</span> <span class="n">clientResources</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleCacheGetError</span><span class="o">(</span><span class="n">RuntimeException</span> <span class="n">exception</span><span class="o">,</span> <span class="n">Cache</span> <span class="n">cache</span><span class="o">,</span> <span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Fail to get cache with key [{}]&#34;</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">exception</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleCachePutError</span><span class="o">(</span><span class="n">RuntimeException</span> <span class="n">exception</span><span class="o">,</span> <span class="n">Cache</span> <span class="n">cache</span><span class="o">,</span> <span class="n">Object</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Fail to put cache with key [{}]&#34;</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">exception</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleCacheEvictError</span><span class="o">(</span><span class="n">RuntimeException</span> <span class="n">exception</span><span class="o">,</span> <span class="n">Cache</span> <span class="n">cache</span><span class="o">,</span> <span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Fail to evict cache with key [{}]&#34;</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">exception</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleCacheClearError</span><span class="o">(</span><span class="n">RuntimeException</span> <span class="n">exception</span><span class="o">,</span> <span class="n">Cache</span> <span class="n">cache</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Fail to clear cache&#34;</span><span class="o">,</span> <span class="n">exception</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦å¤–éœ€è¦æ³¨æ„ï¼Œä¸æ˜¯ç›´æ¥ <code>@Component</code> çš„æ–¹å¼æ³¨å…¥ Spring å®¹å™¨ï¼Œè€Œæ˜¯éœ€è¦åœ¨ç¼“å­˜é…ç½®ç±»ä¸­é…ç½®ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@EnableCaching</span>
<span class="nd">@PropertySource</span><span class="o">(</span><span class="s">&#34;classpath:cache-${spring.profiles.active}.properties&#34;</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CacheConfig</span> <span class="kd">extends</span> <span class="n">CachingConfigurerSupport</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">CacheErrorHandler</span> <span class="nf">errorHandler</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">CacheErrorLoggingHandler</span><span class="o">();;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä½†æ˜¯è¿™æ ·å¤„ç†æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¯·æ±‚ä¼šå¾ˆæ…¢ï¼Œæ¯æ¬¡éƒ½è¦ç­‰ redis è¿æ¥è¶…æ—¶æ—¶é—´x2ï¼Œå› ä¸º CacheManager çš„å®ç°æ˜¯ï¼Œå¦‚æœç¼“å­˜ get å¤±è´¥äº†ï¼Œä¼šä»æ¯”å¦‚æ•°æ®åº“é‡Œå–ï¼Œé‚£ä¹ˆè¿˜ä¼šåš put æ“ä½œå°è¯•æ›´æ–°ç¼“å­˜ï¼Œè¿™æ · get ç­‰ä¸€éï¼Œput å†ç­‰ä¸€éã€‚</p>
<p>äºæ˜¯è€ƒè™‘å¯ä¸å¯ä»¥åœ¨ç¼“å­˜ä¸å¯ç”¨çš„æ—¶å€™ï¼Œå°±ç›´æ¥è¯·æ±‚æ¯”å¦‚æ•°æ®åº“ï¼Œä¸è¦å†åœ¨æŒ‚æ‰çš„ç¼“å­˜è¿™é‡Œç»•ä¸€é“å¼¯å­ã€‚</p>
<h3 id="æ–¹æ¡ˆäºŒ">æ–¹æ¡ˆäºŒ<a href="#æ–¹æ¡ˆäºŒ" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>é¦–å…ˆè€ƒè™‘ä¸ç”¨ç¼“å­˜çš„æƒ…å†µå¦‚ä½•å¤„ç†ï¼ŒSpring æä¾›äº† NoOpCacheManagerï¼Œæä¾›æ²¡æœ‰ç¼“å­˜æ—¶ CacheManager ç›¸å…³æ“ä½œçš„ pass onï¼Œè¿™ä¸ªæ¯”è¾ƒç®€å•ç›´æ¥äº†ï¼Œç›´æ¥ä½¿ç”¨å°±å¥½ã€‚</p>
<p>ç„¶åè€ƒè™‘å¦‚ä½•åšåˆ‡æ¢ï¼ŒSpring ä¸­ç»™æä¾›äº†ä¸€ä¸ª CompositeCacheManagerï¼Œå†…éƒ¨æœ‰ä¸€ä¸ª ArrayList ç±»å‹çš„ cacheManagers å˜é‡ï¼Œå¯ä»¥å­˜å‚¨å¤šä¸ªä¸åŒçš„ CacheManagerï¼Œç»™åˆ‡æ¢æä¾›äº†å¯èƒ½ã€‚</p>
<p>ä¸è¿‡å®é™…è·Ÿäº†ä¸‹ CompositeCacheManager çš„è¡Œä¸ºï¼Œè·Ÿæˆ‘çš„æ„å›¾å¹¶ä¸ä¸€è‡´ï¼Œå®ƒè™½ç„¶ä¼šéå†æ‰€æœ‰çš„ CacheManagerï¼Œä½†æ˜¯åªè¦è¿™ä¸ª CacheManager æœ‰ç›¸åº”çš„ CacheName å°±ä¼šè¿”å›ï¼Œå¹¶ä¸ä¼šåˆ¤æ–­è¿™ä¸ª CacheManager çš„ backstore æ˜¯å¦å¯ç”¨ã€‚æ¢å¥è¯è¯´ï¼ŒCompositeCacheManager çš„ä½¿ç”¨åœºæ™¯æ˜¯è¿™æ ·çš„ï¼šä¸åŒçš„ CacheManager ç®¡ç†ä¸åŒ CacheName çš„ç¼“å­˜ï¼Œæ ¹æ® CacheName è·å–ç¼“å­˜æ—¶ï¼Œå¦‚æœå½“å‰ CacheManager ä¸‹æ²¡æœ‰ï¼Œå°±è¿”å› nullï¼ŒCompositeCacheManager å°±ä¼šå»ä¸‹ä¸€ä¸ª CacheManager å¯»æ‰¾è¿™ä¸ª CacheNameã€‚</p>
<p>è€Œæˆ‘çš„éœ€æ±‚æ˜¯ï¼Œæ ¹æ®ç¼“å­˜çŠ¶æ€åŠ¨æ€å¢æ·» CompositeCacheManager ä¸­çš„ cacheManagers å˜é‡ï¼Œæ¯”å¦‚å½“ Redis æ­£å¸¸è¿è¡Œæ—¶ï¼Œå®ƒå°±æ˜¯ç¬¬ä¸€é¡ºä½è¢«ä½¿ç”¨çš„ï¼Œè€Œå½“ Redis æŒ‚æ‰ä»¥åï¼Œå¯ä»¥å°†å®ƒä» cacheManagers ä¸­å»æ‰ï¼Œé¿å…æ¯æ¬¡è¯·æ±‚å¸¦ç¼“å­˜çš„æ¥å£éƒ½éœ€è¦ç­‰å¾…è¿æ¥è¶…æ—¶ã€‚</p>
<p>ç„¶è€Œï¼ŒCompositeCacheManager ä¸­ cacheManagers å˜é‡å®šä¹‰æ˜¯ final çš„ï¼Œä¸å…è®¸ä¿®æ”¹ï¼Œæš´éœ²çš„æ–¹æ³•ä¹Ÿæ˜¯åªå…è®¸èµ‹å€¼ï¼Œä¸å…è®¸ä¿®æ”¹ï¼Œäºæ˜¯è‡ªå·±ç…§çŒ«ç”»è™å†™äº†ä¸€ä¸ª CustomCompositeCacheManagerï¼Œå®ç°å¯ä»¥åŠ¨æ€å¢æ·» CacheManager çš„åŠŸèƒ½ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomCompositeCacheManager</span> <span class="kd">implements</span> <span class="n">CacheManager</span><span class="o">,</span> <span class="n">InitializingBean</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">CustomCompositeCacheManager</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">private</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">CacheManager</span><span class="o">&gt;</span> <span class="n">cacheManagers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>

    <span class="kd">private</span> <span class="n">CacheManager</span> <span class="n">redisCacheManager</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">fallbackToNoOpCache</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">CustomCompositeCacheManager</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">CustomCompositeCacheManager</span><span class="o">(</span><span class="n">CacheManager</span><span class="o">...</span> <span class="n">cacheManagers</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addCacheManagers</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">cacheManagers</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Nullable</span>
    <span class="kd">public</span> <span class="n">Cache</span> <span class="nf">getCache</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">CacheManager</span> <span class="n">cacheManager</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">cacheManagers</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Cache</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">cacheManager</span><span class="o">.</span><span class="na">getCache</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">cache</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">cache</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getCacheNames</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">names</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">CacheManager</span> <span class="n">manager</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">cacheManagers</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">names</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">manager</span><span class="o">.</span><span class="na">getCacheNames</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableSet</span><span class="o">(</span><span class="n">names</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">fallbackToNoOpCache</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">cacheManagers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">NoOpCacheManager</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFallbackToNoOpCache</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">fallbackToNoOpCache</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">fallbackToNoOpCache</span> <span class="o">=</span> <span class="n">fallbackToNoOpCache</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addCacheManagers</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">CacheManager</span><span class="o">&gt;</span> <span class="n">cacheManagers</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">cacheManagers</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">cacheManagers</span><span class="o">);</span>
        <span class="n">redisCacheManager</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">cacheManagers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deactivateRedisCacheManager</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">cacheManagers</span><span class="o">.</span><span class="na">getFirst</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">redisCacheManager</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;First cache manager is not redis cache manager&#34;</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">cacheManagers</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">activateRedisCacheManager</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cacheManagers</span><span class="o">.</span><span class="na">getFirst</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">redisCacheManager</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;First cache manager already is redis cache manager&#34;</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">cacheManagers</span><span class="o">.</span><span class="na">addFirst</span><span class="o">(</span><span class="n">redisCacheManager</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å› ä¸ºåªç»™å½“å‰é¡¹ç›®ç”¨ï¼Œæ‰€ä»¥å¯¹ RedisCacheManager åšäº†ç‰¹åˆ«å¯¹å¾…ï¼Œæœ‰ä¸¤ä¸ªå‡½æ•° activateRedisCacheManager å’Œ deactivateRedisCacheManagerï¼Œä¸“é—¨ç”¨äºæ·»åŠ å’Œåˆ é™¤å®ƒã€‚é‚£ä¹ˆä»€ä¹ˆæ—¶å€™è°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°å‘¢ï¼Ÿä¹Ÿå³ï¼Œæ€ä¹ˆåˆ¤æ–­ Redis ä¸Šçº¿äº†ã€æŒ‚æ‰äº†å‘¢ï¼Ÿ</p>
<p>ï¼ˆæœªè¢«é‡‡å–çš„ï¼‰ç¬¬ä¸€ååº”æ˜¯ï¼ŒHealthCheckï¼ŒSpringboot æµæ´¾ä¸­ï¼Œæœ€å¸¸ç”¨çš„å°±æ˜¯ spring-boot-actuator äº†ï¼Œå‚è€ƒå®ƒçš„ RedisHealthIndicator ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doHealthCheck</span><span class="o">(</span><span class="n">Health</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">RedisConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">RedisConnectionUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">redisConnectionFactory</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">connection</span> <span class="k">instanceof</span> <span class="n">RedisClusterConnection</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ClusterInfo</span> <span class="n">clusterInfo</span> <span class="o">=</span> <span class="o">((</span><span class="n">RedisClusterConnection</span><span class="o">)</span> <span class="n">connection</span><span class="o">).</span><span class="na">clusterGetClusterInfo</span><span class="o">();</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">up</span><span class="o">().</span><span class="na">withDetail</span><span class="o">(</span><span class="s">&#34;cluster_size&#34;</span><span class="o">,</span> <span class="n">clusterInfo</span><span class="o">.</span><span class="na">getClusterSize</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">withDetail</span><span class="o">(</span><span class="s">&#34;slots_up&#34;</span><span class="o">,</span> <span class="n">clusterInfo</span><span class="o">.</span><span class="na">getSlotsOk</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">withDetail</span><span class="o">(</span><span class="s">&#34;slots_fail&#34;</span><span class="o">,</span> <span class="n">clusterInfo</span><span class="o">.</span><span class="na">getSlotsFail</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// å› ä¸ºé¡¹ç›®ä¸­ç”¨åˆ°çš„ redis æ˜¯å“¨å…µæœºåˆ¶éƒ¨ç½²çš„ï¼Œæ‰€ä»¥å…³é”®çš„å°±æ˜¯ä¸‹é¢è¿™ä¸€è¡Œäº†
</span><span class="c1"></span>            <span class="n">Properties</span> <span class="n">info</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">info</span><span class="o">();</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">up</span><span class="o">().</span><span class="na">withDetail</span><span class="o">(</span><span class="n">VERSION</span><span class="o">,</span> <span class="n">info</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">REDIS_VERSION</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">finally</span> <span class="o">{</span>
        <span class="n">RedisConnectionUtils</span><span class="o">.</span><span class="na">releaseConnection</span><span class="o">(</span><span class="n">connection</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">redisConnectionFactory</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶è€Œæ•ˆæœå¹¶ä¸å¥½ï¼Œé¦–å…ˆï¼Œå®ƒæ˜¯è¢«è°ƒç”¨çš„ä¸€æ–¹ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘è¦ç”¨ç±»ä¼¼çš„æ–¹å¼æ£€æµ‹ï¼Œè¿˜éœ€è¦è‡ªå·±å†èµ·ä¸€ä¸ªçº¿ç¨‹ä¸æ–­æŸ¥è¯¢ï¼›å…¶æ¬¡ï¼Œå¦‚æœ redis æŒ‚äº†ï¼Œconnection.info() å°±ä¼šå…ˆç­‰å¾…è¶…æ—¶ï¼Œç„¶åæŠ›å‡ºå¼‚å¸¸ï¼Œå’Œæ­£å¸¸çš„ç¼“å­˜æ“ä½œæ•°æ®æµç¨‹æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä½œä¸ºä¸€ä¸ªæ£€æµ‹æ˜¯å¦å¯ç”¨çš„æœºåˆ¶ï¼Œæ„Ÿè§‰å¾ˆä¸ä¼˜é›…ã€‚</p>
<p>å…œå…œè½¬è½¬ï¼Œå‘ç° lettuce æä¾›äº†<a href="https://github.com/lettuce-io/lettuce-core/wiki/Connection-Events">äº‹ä»¶ç›‘å¬æœºåˆ¶</a>ï¼Œå¯ä»¥æ³¨å†Œç›‘å¬ reids çš„ä¸Šçº¿ã€ä¸‹çº¿äº‹ä»¶ï¼Œæ­£ä¸­ä¸‹æ€€ï¼Œäºæ˜¯ä¿®æ”¹ CacheConfig é…ç½®ç±»ï¼Œæ·»åŠ äº‹ä»¶æ³¨å†Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@EnableCaching</span>
<span class="nd">@PropertySource</span><span class="o">(</span><span class="s">&#34;classpath:cache-${spring.profiles.active}.properties&#34;</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CacheConfig</span> <span class="kd">extends</span> <span class="n">CachingConfigurerSupport</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">LettuceConnectionFactory</span> <span class="n">lettuceConnectionFactory</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Lazy</span>
    <span class="kd">private</span> <span class="n">CustomCompositeCacheManager</span> <span class="n">frequentCacheManager</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">CacheErrorHandler</span> <span class="nf">errorHandler</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">CacheErrorLoggingHandler</span><span class="o">();;</span>
    <span class="o">}</span>

    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">LettuceClientConfiguration</span> <span class="n">clientConfiguration</span> <span class="o">=</span> <span class="n">lettuceConnectionFactory</span><span class="o">.</span><span class="na">getClientConfiguration</span><span class="o">();</span>
        <span class="n">Optional</span><span class="o">&lt;</span><span class="n">ClientResources</span><span class="o">&gt;</span> <span class="n">clientResources</span> <span class="o">=</span> <span class="n">clientConfiguration</span><span class="o">.</span><span class="na">getClientResources</span><span class="o">();</span>

        <span class="n">clientResources</span><span class="o">.</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">resources</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">resources</span><span class="o">.</span><span class="na">eventBus</span><span class="o">().</span><span class="na">get</span><span class="o">().</span><span class="na">subscribe</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Caught cache event: {}&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">ConnectionDeactivatedEvent</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;ConnectionDeactivatedEvent&#34;</span><span class="o">);</span>
                    <span class="n">frequentCacheManager</span><span class="o">.</span><span class="na">deactivateRedisCacheManager</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">ConnectionActivatedEvent</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;ConnectionActivatedEvent&#34;</span><span class="o">);</span>
                    <span class="n">frequentCacheManager</span><span class="o">.</span><span class="na">activateRedisCacheManager</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¿ä¸ä½èµç¾ lettuceï¼Œæµ‹è¯•ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå°† redis æŒ‚æ‰å†å¯åŠ¨ï¼Œäº‹ä»¶é€šçŸ¥éå¸¸çµæ•ï¼Œæ•´ä¸ªè¿è¡Œæµç¨‹å®Œå…¨å¦‚æˆ‘é¢„æµ‹ï¼š</p>
<ul>
<li>redis æœåŠ¡ä¸‹çº¿ï¼ŒdeactivateRedisCacheManager æ–¹æ³•è¢«è§¦å‘ï¼ŒRedisCacheManager è¢«ä»å¯ç”¨ cacheManagers ä¸­ç§»é™¤ï¼Œå†æ¬¡è¯·æ±‚å¸¦ç¼“å­˜çš„æ–¹æ³•æ—¶ï¼Œç”± cacheManagers ä¸­ä¸‹ä¸€é¡ºä½çš„ CacheManager ï¼ˆæ¯”å¦‚ NoOpCacheManagerï¼‰å¤„ç†</li>
<li>redis æœåŠ¡ä¸Šçº¿ï¼ŒactivateRedisCacheManager() æ–¹æ³•è¢«è§¦å‘ï¼ŒRedisCacheManager ä½œä¸ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹é‡æ–°å›åˆ° cacheManagers é˜Ÿåˆ—ï¼Œå†æ¬¡è¯·æ±‚å¸¦ç¼“å­˜çš„æ–¹æ³•æ—¶ï¼Œä¼˜å…ˆç¼“å­˜åˆ° redis ä¸­</li>
</ul>
<h2 id="ä¸å¤šçº§ç¼“å­˜å¯¹æ¯”">ä¸å¤šçº§ç¼“å­˜å¯¹æ¯”<a href="#ä¸å¤šçº§ç¼“å­˜å¯¹æ¯”" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>æåˆ°ç¼“å­˜ï¼Œå°±è‚¯å®šä¼šæƒ³åˆ°å¤šçº§ç¼“å­˜ï¼ˆå§ï¼Ÿï¼‰æœ¬ç¯‡è®¨è®ºçš„è™½ç„¶ä¹Ÿæ¶‰åŠå¤šä¸ªç¼“å­˜ï¼ˆå‡å¦‚æŠŠ NoOpCacheManager ä¹Ÿçœ‹ä½œä¸€ç§ç‰¹æ®Šç¼“å­˜ï¼‰ï¼Œä½†æ˜¯ä¾§é‡ç‚¹ä¸åŒï¼š</p>
<ul>
<li>å¤šçº§ç¼“å­˜ä¸»è¦ç›®æ ‡æ˜¯è¿›ä¸€æ­¥æé«˜è®¿é—®é€Ÿåº¦ï¼Œåœ¨ redis è¿™ç§è¿œç¨‹çš„åˆ†å¸ƒå¼ç¼“å­˜ä¹‹ä¸Šï¼Œå†åŠ ä¸€å±‚æœ¬åœ°å†…å­˜ç¼“å­˜ï¼Œæ¯”å¦‚ caffeine æˆ–è€… ehcacheï¼Œæ›´æ–°ç¼“å­˜æ—¶ï¼Œè¦è€ƒè™‘å¤šçº§ç¼“å­˜ä¸­çš„æ•°æ®ä¸€è‡´æ€§ï¼Œæ˜¾ç„¶ä¹Ÿä¸æ˜¯ CacheManager çš„é€‚ç”¨åœºæ™¯ã€‚</li>
<li>æœ¬ç¯‡ä¸»è¦è€ƒè™‘ç¼“å­˜æ•…éšœä»¥åŠæ•…éšœä¿®å¤æƒ…å†µä¸‹ï¼Œåº”ç”¨ä½¿ç”¨çš„ç¼“å­˜åŠ¨æ€åˆ‡æ¢ã€‚éœ€è¦è€ƒè™‘çš„æ˜¯æ•°æ® stale é—®é¢˜ï¼Œæ¯”å¦‚æ•…éšœæœŸé—´æ•°æ®å·²è¿‡æœŸï¼Œç”±äº redis æ•…éšœæœªå¾—åˆ°åŠæ—¶æ›´æ–°ï¼Œä¿®å¤åç¨‹åºå†æ¬¡åˆ‡æ¢ä½¿ç”¨ redisï¼Œå…¶ä¸­ä¿å­˜çš„å·²è¿‡æœŸæ•°æ®å°±ä¼šå½±å“ç¨‹åºé€»è¾‘ã€‚</li>
</ul>
<h2 id="é—®é¢˜">é—®é¢˜<a href="#é—®é¢˜" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="ç¨‹åºå¯åŠ¨æ—¶-redis-æœªå°±ç»ª">ç¨‹åºå¯åŠ¨æ—¶ redis æœªå°±ç»ª<a href="#ç¨‹åºå¯åŠ¨æ—¶-redis-æœªå°±ç»ª" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>ç„¶è€Œè¿˜æ˜¯æœ‰é—®é¢˜çš„ï¼Œå¦‚æœç¨‹åºå¯åŠ¨å‰ï¼Œredis å°±æŒ‚äº†ï¼Œé‚£ä¹ˆ lettuce æ˜¯ä¸ä¼šå‘å¸ƒä»»ä½•äº‹ä»¶çš„ï¼Œå³ä½¿åæ¥ redis åˆä¸Šçº¿äº†ï¼Œä¹Ÿä¸ä¼šæœ‰äº‹ä»¶é€šçŸ¥ï¼Œä»¥åå¦‚æœå»è¯·æ±‚å¸¦ç¼“å­˜çš„æ–¹æ³•ï¼Œå°±ä¼šæ¬¡æ¬¡è¿›å…¥ ErrorHandler å¤„ç†æµç¨‹ï¼Œä¹Ÿå°±æ˜¯äº‹ä»¶ç›‘å¬å™¨æ²¡æœ‰èµ·åˆ°ä»»ä½•ä½œç”¨ã€‚</p>
<p>æ­¤å¤„çŒœæµ‹ï¼ˆæœªéªŒè¯ï¼‰ï¼Œlettuce çš„äº‹ä»¶å‘å¸ƒï¼Œæ˜¯è®¢é˜…äº† redis çš„äº‹ä»¶é¢‘é“ï¼Œæ‰€ä»¥å¦‚æœæœ€å¼€å§‹æ²¡æœ‰æ­£ç¡®è¿æ¥åˆ° reids çš„è¯ ï¼Œç¨‹åºä¸­è®¢é˜…çš„ lettuce çš„äº‹ä»¶ä¹Ÿå°±åºŸäº†ã€‚</p>
<p>ä¸è¿‡å¯¹äº standalone çš„ redis ä¸Šçº¿äº‹ä»¶ï¼Œåˆæ˜¯æ€ä¹ˆç›‘å¬åˆ°çš„å‘¢ï¼Ÿä¸ç†è§£å‘€ã€‚</p>
<h3 id="redis-æ•…éšœæœŸé—´ç¼“å­˜æ•°æ®è¿‡æœŸ">redis æ•…éšœæœŸé—´ç¼“å­˜æ•°æ®è¿‡æœŸ<a href="#redis-æ•…éšœæœŸé—´ç¼“å­˜æ•°æ®è¿‡æœŸ" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>ä¸€ä¸ªæ˜¯è®¾ç½®æ¯”è¾ƒçŸ­çš„ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œå°½é‡å‡å°‘é‡åˆ°è¿™ç§æƒ…å†µçš„æ¦‚ç‡ ğŸ˜‚
ä¸€ä¸ªæ˜¯æ¯”è¾ƒä¿é™©çš„åŠæ³•ï¼Œä½†æ˜¯ä¹Ÿæ¯”è¾ƒä½æ•ˆï¼Œå°±æ˜¯æ•…éšœä¿®å¤ååˆ‡å›ä½¿ç”¨ redis æ—¶ï¼ŒæŠŠæ‰€æœ‰ç¼“å­˜ evict æ‰ï¼Œç­‰å¾…ä¸‹æ¬¡è¯·æ±‚é‡æ–° putã€‚</p>
<h2 id="é¢˜å¤–è¯">é¢˜å¤–è¯<a href="#é¢˜å¤–è¯" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>å…³äºç¼“å­˜ç©¿é€é—®é¢˜ï¼Œå°±æ˜¯ä¸æ€€å¥½æ„çš„ç”¨æˆ·ä½¿ç”¨å¤§é‡ä¸å­˜åœ¨çš„å‚æ•°æŸ¥è¯¢ï¼Œå‡»ç©¿ç¼“å­˜å±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ï¼Œä»è€Œè¾¾åˆ°æ‰“æŒ‚æ•°æ®çš„ç›®çš„ï¼Œæœ€å¼€å§‹çœ‹åˆ°çš„åŠæ³•æ˜¯ï¼Œæ¥ä¸€ä¸ªè¯·æ±‚å°±ç¼“å­˜ä¸€ä¸ªå¹¶ä¸”æŠŠè¿”å›å€¼è®¾ç½®ä¸º null ä¹‹ç±»çš„ï¼Œå°½é‡å‡å°‘åˆ°æ•°æ®åº“çš„è¯·æ±‚ã€‚è™½ç„¶å¥½åƒä¹Ÿèƒ½è¡Œï¼Œä½†æ˜¯å¦‚æœäººå®¶ç”¨çš„æµ·é‡ä¸é‡å¤çš„è¯·æ±‚ï¼Œä¸å°±é¡ºå¸¦å‡»å®ä½ çš„ redis äº†å—ï¼ŸğŸ˜‚</p>
<p>åæ¥çœ‹åˆ°ä¸€ç§è§£å†³åŠæ³•æ˜¯ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼Œæ„Ÿè§‰è„‘è¢‹è¢«æ•²äº†ä¸€ä¸‹ï¼Œå“å‘€ï¼Œè¿™ä¸ªå‰å®³å‘€ï¼å†…å­˜å ç”¨åˆå°‘ï¼Œåˆæ‹¦ä½äº†æ¶æ„è¯·æ±‚ã€‚ç‚¹èµï¼ğŸ‘</p>

			</div>

<div class="related-posts thin">
	<h2>ç›¸å…³æ¨è</h2>
	<ul>
	
	<li><a href="/post/spring-config/">ä½¿çº¿ä¸Š Spring åº”ç”¨æ›´å¥½éƒ¨ç½²å’Œè°ƒè¯•</a></li>
	
	<li><a href="/post/config-server-with-spring-boot-and-disconf/">åŸºäº Spring Boot &#43; Disconf çš„é…ç½®ä¸­å¿ƒ</a></li>
	
	</ul>
</div>

			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://kyon.life/tags/spring">spring</a></span><span class="tag"><a href="https://kyon.life/tags/cache">cache</a></span><span class="tag"><a href="https://kyon.life/tags/redis">redis</a></span><span class="tag"><a href="https://kyon.life/tags/%E5%88%86%E4%BA%AB">åˆ†äº«</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>çº¦ 7676 å­—</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2020-09-29 15:40</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"></circle><line x1="1.05" y1="12" x2="7" y2="12"></line><line x1="17.01" y1="12" x2="22.96" y2="12"></line></svg><a href="https://github.com/kyon0304/kyon0304.github.io/5d1291eff84f99177f2b55dc7ea896b2ecce2c8d/a7666d216953621da5cea4c3710181cdfe449773" target="_blank" rel="noopener">a7666d2</a> @ 2021-02-26</p>
			</footer>
			
			
			<div class="social-share" data-initialized="true" data-wechat-qrcode-title="æ‰«æåˆ†äº«">
    <center>
        <span style="font-size:16px;color:#c05b4d;">åˆ†äº«åˆ°ï¼š</span>
        <a href="#" class="social-share-icon icon-weibo"></a>
        <a href="#" class="social-share-icon icon-wechat"></a>
        <a href="#" class="social-share-icon icon-twitter"></a>
        <a href="#" class="social-share-icon icon-qq"></a>
        <a href="#" class="social-share-icon icon-qzone"></a>
    </center>
</div>

<script src="/js/social-share.min.js"></script>

		</article>

		
		<aside class="post-toc" id="toc">
			<nav id="TableOfContents">
  <ul>
    <li><a href="#ç°çŠ¶">ç°çŠ¶</a></li>
    <li><a href="#ç›®æ ‡">ç›®æ ‡</a></li>
    <li><a href="#è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</a>
      <ul>
        <li><a href="#æ–¹æ¡ˆä¸€">æ–¹æ¡ˆä¸€</a></li>
        <li><a href="#æ–¹æ¡ˆäºŒ">æ–¹æ¡ˆäºŒ</a></li>
      </ul>
    </li>
    <li><a href="#ä¸å¤šçº§ç¼“å­˜å¯¹æ¯”">ä¸å¤šçº§ç¼“å­˜å¯¹æ¯”</a></li>
    <li><a href="#é—®é¢˜">é—®é¢˜</a>
      <ul>
        <li><a href="#ç¨‹åºå¯åŠ¨æ—¶-redis-æœªå°±ç»ª">ç¨‹åºå¯åŠ¨æ—¶ redis æœªå°±ç»ª</a></li>
        <li><a href="#redis-æ•…éšœæœŸé—´ç¼“å­˜æ•°æ®è¿‡æœŸ">redis æ•…éšœæœŸé—´ç¼“å­˜æ•°æ®è¿‡æœŸ</a></li>
      </ul>
    </li>
    <li><a href="#é¢˜å¤–è¯">é¢˜å¤–è¯</a></li>
  </ul>
</nav>
		</aside>
	</main>
	<div class="post-nav thin">
		<a class="next-post" href="https://kyon.life/post/java-garbage-collector/">
			<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;æ–°</span><br><span>ç¬¬ä¸‰ç«  åƒåœ¾æ”¶é›†å™¨ä¸å†…å­˜åˆ†é…ç­–ç•¥</span>
		</a>
		<a class="prev-post" href="https://kyon.life/post/philosophy-of-software-design-3/">
			<span class="post-nav-label">æ—§&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>Philosophy of Software Design ç¬¬ä¸‰ç«  ä»…ä»…èƒ½å·¥ä½œçš„ä»£ç æ˜¯ä¸å¤Ÿçš„ï¼ˆç¼–ç¨‹æ—¶çš„æˆ˜ç•¥ vs æˆ˜æœ¯æ€ç»´ï¼‰</span>
		</a>
	</div>
	<div id="comments" class="thin">
<script src="https://utteranc.es/client.js"
      repo="kyon0304/kyon0304.github.io"
      issue-term="pathname"
      label="Comment"
      theme="github-light"
      crossorigin="anonymous"
      async>
</script>
</div>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2021 <a href="https://kyon.life/">kyon</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://kyon.life/sitemap.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>



	<script src="https://kyon.life/js/bundle.min.79c6d5f9ef3feaf373d9e8be6686758cedbc40420054863902f5b9bc97cf4f2d.js" integrity="sha256-ecbV+e8/6vNz2ei+ZoZ1jO28QEIAVIY5AvW5vJfPTy0=" crossorigin="anonymous"></script>
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-131420074-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


	
  
  
  
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-131420074-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script src="/js/social-share.min.js"></script>



</body>

</html>
